{% extends "base.html" %}

{% block title %}WireGuard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h2>Клиенты WireGuard</h2>
    <div class="d-flex align-items-center gap-4">
        <label class="switch d-flex align-items-center gap-2 mb-0">
            <input type="checkbox" id="auto-refresh-toggle">
            <span class="slider round"></span>
            <span title="Автообновление данных страницы каждые 3 сек.">Автообновление</span>
        </label>
        <label class="switch d-flex align-items-center gap-2 mb-0">
            <input type="checkbox" id="online-only-toggle">
            <span class="slider round"></span>
            <span title="Скрывать оффлайн клиентов">Только онлайн</span>
        </label>
    </div>
</div>
<div id="no-active-clients" class="card text-center shadow-sm my-4">
    <div class="card-body">
        <h5 class="card-title">Нет активных подключений</h5>
        <p class="card-text text-muted">Клиенты оффлайн, статистика появится при подключении.</p>
    </div>
</div>
<div id="wg-stats-container">
    {% for interface in stats %}
    <div class="table-responsive w-100 mb-4">
        <table class="table align-middle text-center">
            <thead>
                <tr>
                    <th colspan="4" class="text-start fs-5 align-middle">
                        <div class="d-flex align-items-center flex-wrap">
                            <span class="me-2">
                                Интерфейс: {{ interface.interface.upper() if interface.interface|lower == 'vpn' else
                                interface.interface|capitalize }}
                            </span>
                            <span class="badge bg-dark">
                                <strong> {{ interface.peers | selectattr('online') | list | length }}</strong>
                                / <strong>{{ interface.peers | length }}</strong>
                            </span>
                        </div>
                    </th>
                    <th></th>
                    <th colspan="2" title="Суточная статистика">Сегодня</th>
                    <th colspan="2" title="Итоговая статистика">Всего</th>
                </tr>
                <tr>
                    <th>Статус</th>
                    <th>Клиент</th>
                    <th>Реальный IP</th>
                    <th>Локальный IP</th>
                    <th style="width: 200px;">Рукопожатие</th>
                    <th title="Передано клиенту">Получено</th>
                    <th title="Получено от клиента">Передано</th>
                    <th title="Передано клиенту">Получено</th>
                    <th title="Получено от клиента">Передано</th>
                </tr>
            </thead>
            <tbody id="tbody-{{ interface.interface }}"></tbody>
        </table>
    </div>
    {% endfor %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const stats = {{ stats|tojson }};
    
    stats.forEach(interface => {
        const tbody = document.getElementById(`tbody-${interface.interface}`);
        if (!tbody) return;

        let index = 0;
        let onlineCount = 0;

        function renderChunk() {
            if (index >= interface.peers.length) return;

            const peer = interface.peers[index];
            const tr = document.createElement("tr");
            tr.className = peer.online ? "traffic-online" : "traffic-offline wg_table";

            if(peer.online) onlineCount++;

            tr.innerHTML = `
                <td>
                    <small class="${peer.online ? 'text-success' : 'traffic-offline'} fs-8">
                        ${peer.online ? 'Онлайн' : 'Офлайн'}
                    </small>
                </td>
                <td title="Peer: ${peer.masked_peer}">${peer.client}</td>
                <td>${peer.endpoint || 'N/A'}</td>
                <td>${peer.visible_ips.join(', ')}</td>
                <td>${peer.latest_handshake || 'N/A'}</td>
                <td>${peer.daily_received || '0.0'}</td>
                <td>${peer.daily_sent || '0.0'}</td>
                <td>${peer.received || '0.0'}</td>
                <td>${peer.sent || '0.0'}</td>
            `;

            tbody.appendChild(tr);
            document.getElementById(`online-count-${interface.interface}`).textContent = onlineCount;

            index++;
            setTimeout(renderChunk, 5); 
        }

        renderChunk();
    });
});
</script>



<script src="{{ url_for('static', filename='js/wg_page.js') }}"></script>
{% endblock %}